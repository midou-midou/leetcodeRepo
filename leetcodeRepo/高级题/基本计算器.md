# 基本计算器

## 题目要求

给你一个字符串表达式 s ，请你实现一个基本计算器来计算并返回它的值。

注意:不允许使用任何将字符串作为数学表达式计算的内置函数，比如 eval() 。

### 示例

```js
输入：s = "(1+ (4+5+2) - 3)+( 6 + 8 )"
输出：23
```

## 思路

先确定大体思路：要逐个扫描字符串中的字符，碰到"+"、"-"就要计算前后的两个数字的值，如果不是数字，就按照其他字符的处理规则处理  
要定义一个栈结构，如果栈最后三个字符正好可以形成加减运算表达式，就取出来计算，之后回填进`calStack`栈  
如果是反括号就要找到正括号，且这俩括号之间的字符又要按照字符处理方法来处理  
数字处理要看数字前后是否也是数字，如果也是数字，说明扫描的这个待处理的数字没有扫描完（比如2341，扫描到2，后面是3，要和前面的2连起来）

```js
/**
 * @param {string} s
 * @return {number}
 */
var calculate = function(s) {
    let calStack = []
    let res = 0
    const operators = {
        '+': (a, b) => a + b,
        '-': (a, b) => a - b
    }

    const isNumber = (str) => (str && !isNaN(str) && str !== ' ') || str === 0

    const isOper = (str) => str === '+' || str === '-'

    // 这里判断栈中的最后三个字符是否构成能计算的表达式
    const isCanCal = () => {
        let last = calStack.length - 1
        return isNumber(calStack[last]) && isNumber(calStack[last - 2]) && isOper(calStack[last - 1])
    }

    // 处理加法、减法
    const plusAndMinus = () => {
        let [left, oper, right] = calStack.splice(-3)
        let last = calStack.length - 1
        // 如果左操作数是一个负数
        if (calStack[last] === '-') {
            left = -(+left)
            calStack.pop()
        }
        calStack.push(operators[oper](+left, +right))
    }

    // 处理数字
    const handleNumbers = (str) => {
        // 如果栈中前一个也为数字，则字符串累加
        let last = calStack.length - 1
        if (isNumber(calStack[last])) {
            calStack[last] += str
        } else {
            calStack.push(str)
        }
    }

    // 处理反括号')'
    const handleParentheses = () => {
        let t = calStack.pop()
        let oper = calStack.pop()

        if (oper === '(') {
            calStack.push(t)
        } else {
            // 如果是字符串形式的负数 eg. '-1'或者'-114514'
            oper = calStack.pop()
            if (oper === '(') {
                calStack.push(-(+t))
            }
        }
    }

    const popRes = () => {
        // 这里要处理负数的计算结果
        let [oper, r] = calStack
        if (!r) return +(oper);
        if (oper === '-') return -(+r);
        return +r;
    }

    const cal = () => {
        for (let i = 0; i < s.length; i++) {
            let str = s[i]

            if (str === '+') {
                calStack.push(str)
            } else if (str === '-') {
                calStack.push(str)
            } else if (str === '(') {
                calStack.push(str)
            } else if (str === ')') {
                handleParentheses()
            } else if (isNumber(str)) {
                // 数字
                handleNumbers(str)
                // 如果下一位还是数字，则需要拼接
                if (isNumber(s[i + 1])) continue
            } else if (str === ' ') {
                continue
            }

            if (isCanCal()) {
                plusAndMinus()
            }
        }
    }

    cal()
    res = popRes()

    return res
};
```
